---
title: 学习《Windows 内核安全编程技术实践》（12）
date: 2024-02-02 11:04:38
tags: [Windows, Kernel, Driver]
categories: [Learning, Windows 内核安全编程技术实践]
---

## 断链隐藏驱动程序自身

本章节参考：[驱动开发：断链隐藏驱动程序自身](https://www.lyshark.com/post/d9ac45b2.html)

### 概念

断链隐藏驱动自身是一种高级的技术，其目的是将驱动自身的模块信息从系统的模块列表中移除，从而使其在系统中不可见。这样做可以增加驱动的隐蔽性，使其更难被检测和卸载。断链隐藏驱动自身也是通过修改驱动模块的链表结构来实现的。

### 实现步骤

具体步骤如下：

1. 获取驱动模块的链表指针。驱动模块的链表可以通过访问 DriverObject->DriverSection 来获取。
2. 修改链表结构。通过修改链表中相邻模块的指针，将自身模块从链表中移除。这样做将使系统无法访问到驱动模块，从而达到隐藏的效果。

### 实现代码

```c
#include <ntifs.h>

HANDLE hThread;

VOID ThreadRun(PVOID StartContext)
{
	LARGE_INTEGER times;
	PDRIVER_OBJECT pDriverObject;

	// 等待3秒  单位是纳秒
	times.QuadPart = -30 * 1000 * 1000;

	KeDelayExecutionThread(KernelMode, FALSE, &times);
	pDriverObject = (PDRIVER_OBJECT)StartContext;

	// 修改模块信息
	pDriverObject->DriverSize = 0;
	pDriverObject->DriverSection = NULL;
	pDriverObject->DriverExtension = NULL;
	pDriverObject->DriverStart = NULL;
	pDriverObject->DriverInit = NULL;
	pDriverObject->FastIoDispatch = NULL;
	pDriverObject->DriverStartIo = NULL;

	ZwClose(hThread);
}

VOID UnDriver(PDRIVER_OBJECT driver)
{
	DbgPrint(("Uninstall Driver Is OK \n"));
}

NTSTATUS DriverEntry(IN PDRIVER_OBJECT Driver, PUNICODE_STRING RegistryPath)
{
	DbgPrint(("hello lyshark \n"));

	PLIST_ENTRY pModuleList;
	pModuleList = Driver->DriverSection;

	// 前一个模块的Flink=本模块的Flink
	pModuleList->Blink->Flink = pModuleList->Flink;

	// 前一个模块的Blink=本模块的Blink
	pModuleList->Flink->Blink = pModuleList->Blink;
	PsCreateSystemThread(&hThread, GENERIC_ALL, NULL, NULL, NULL, ThreadRun, Driver);

	Driver->DriverUnload = UnDriver;
	return STATUS_SUCCESS;
}

```
